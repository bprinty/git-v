#!/usr/bin/env sh
#
# git plugin for managing version numbering
# 
# @author <bprinty@gmail.com>
# ------------------------------------------------


# meta
# ----
usage() {
    echo "usage: git v [--version] [--help] [--reset] <command> [<args>]"
    echo
    echo "Available subcommands are:"
    echo "  add       Add file to be tracked by git-v."
    echo "  remove    Remove file for tracking via git-v."
    echo "  list      List version information for tracked files."
    echo "  up        Increment version numbers for tracked files."
    echo "  down      Decrement version numbers for tracked files."
    echo "  rc        Add release cycle commit hash on version number for tracked files."
    echo
}

version() {
    echo "0.0.1"
}


# exec
# ----
main() {
    if [ "$#" -lt 1 ]; then
        usage; exit 1
    fi

    local subcommand="$1"; shift

    case $subcommand in
        "-h"|"--help")
            usage; exit 0
            ;;
        "-v"|"--version")
            version; exit 0
            ;;
        "-r"|"--reset")
            rm -rf "$base/.git/version"; exit 0
            ;;
    esac

    # set up git working directory
    local workingdir=$(dirname "$(echo "$0" | sed -e 's,\\,/,g')")
    if [ ! -e "$workingdir/git-v-$subcommand" ]; then
        usage; exit 1
    fi

    # ensure user is inside git repository
    if [ ! -e "$base" ]; then
        exit 1
    fi

    # create directory if not exists
    if [ ! -e "$base/.git/version" ]; then
        mkdir "$base/.git/version"
    fi
    touch "$marks"

    # add .versions file to marks
    if [ -e "$base/.version" ]; then
        cat "$base/.version" >> "$marks"
        sort "$marks" | uniq > "$marks.tmp"
        mv "$marks.tmp" "$marks"
    fi

    sh "$workingdir/git-v-$subcommand" "$@"
}

base=`git rev-parse --show-toplevel`
marks="$base/.git/version/marks"
main "$@"

